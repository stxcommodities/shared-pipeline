# Converted from Bitbucket Pipelines
# Uses arc-tde-runner for GitHub Actions

name: TDE Shared Pipeline
'on':
  workflow_call:
    secrets:
      SSH_KEY_TDE:
        required: true
  push:
    branches:
      - main
      - master

jobs:
  tde:
    name: TDE
    runs-on: arc-tde-runner
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create update line
        run: |
          echo "$(date -u +%s) git@github.com:${{ github.repository }}.git" > ${{ github.workspace }}/update_line

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY_TDE }}" > ~/.ssh/tde_key
          chmod 600 ~/.ssh/tde_key
          echo -e "Host datahive.online\n  StrictHostKeyChecking no\n  UserKnownHostsFile /dev/null" > ~/.ssh/config

      - name: Deploy update line
        run: |
          scp -i ~/.ssh/tde_key ${{ github.workspace }}/update_line bb@datahive.online:/mnt/tde-in/github/

      - name: Append to git updates
        run: |
          ssh -i ~/.ssh/tde_key bb@datahive.online "cat /mnt/tde-in/github/update_line >> /mnt/tde-in/github_git_updates.txt && rm -f /mnt/tde-in/github/update_line"

      - name: Create last run file
        run: |
          echo "${{ github.event.repository.name }}" > ${{ github.workspace }}/last_run
          date >> ${{ github.workspace }}/last_run

      - name: Deploy last run
        run: |
          scp -i ~/.ssh/tde_key ${{ github.workspace }}/last_run bb@datahive.online:/mnt/tde-in/github/

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/tde_key
