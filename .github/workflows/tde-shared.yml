# Converted from Bitbucket Pipelines (export: true â†’ workflow_call)
# Equivalent of: definitions.pipelines.tde

name: TDE Shared Pipeline

on:
  workflow_call:
    secrets:
      SSH_KEY_TDE:
        required: true

jobs:
  tde:
    name: TDE
    runs-on: arc-tde-runner
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY_TDE }}" > ~/.ssh/tde_key
          chmod 600 ~/.ssh/tde_key
          cat >> ~/.ssh/config <<'EOF'
          Host tde-aws.stxaws.net
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            IdentityFile ~/.ssh/tde_key
          EOF
          chmod 600 ~/.ssh/config

      - name: Create and deploy update line
        run: |
          echo "$(date -u +%s) git@github.com:${{ github.repository }}.git" > "${{ github.workspace }}/update_line"
          scp "${{ github.workspace }}/update_line" bb@tde-aws.stxaws.net:/mnt/tde-in/bit-bucket/

      - name: Append to git updates
        run: |
          ssh bb@tde-aws.stxaws.net "cat /mnt/tde-in/bit-bucket/update_line >> /mnt/tde-in/bit-bucket_git_updates.txt && rm -f /mnt/tde-in/bit-bucket/update_line"

      - name: Create and deploy last run
        run: |
          echo "${{ github.event.repository.name }}" > "${{ github.workspace }}/last_run"
          date >> "${{ github.workspace }}/last_run"
          scp "${{ github.workspace }}/last_run" bb@tde-aws.stxaws.net:/mnt/tde-in/bit-bucket/

      - name: Cleanup SSH
        if: always()
        run: rm -f ~/.ssh/tde_key ~/.ssh/config
